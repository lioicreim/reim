/**
 * 필터 코드 생성기
 * 프리셋 설정과 티어 리스트 데이터를 기반으로 .filter 파일 형식의 코드를 생성합니다.
 */

import bases from "@/data/bases.json";
import classes from "@/data/classes.json";
import currencyTiers from "@/data/currency-tiers.json";
import filterRules from "@/data/filter-rules.json";
import presets from "@/data/presets.json";
import currencyItemCategories from "@/data/currency-item-categories.json";
import modsTiersData from "@/data/mods-tiers.json";

/**
 * 필터 코드 생성
 * @param {Object} options - 필터 생성 옵션
 * @param {string} options.presetId - 프리셋 ID
 * @param {boolean} options.isPS5 - PS5 모드 여부
 * @param {Object} options.excludedOptions - 제외 옵션
 * @param {Object} options.customGearTiers - 커스텀 장비 티어 (로컬스토리지에서)
 * @param {Object} options.customCurrencyTiers - 커스텀 화폐 티어 (로컬스토리지에서)
 * @param {string} options.selectedLeague - 선택된 리그 (기본값, early, normal, late, ssf)
 * @returns {string} 생성된 필터 코드
 */
export function generateFilterCode(options) {
  const {
    presetId = "starter",
    soundOption = "default", // default(PC), ps5, s_only, none
    excludedOptions = {},
    customGearTiers = {},
    customCurrencyTiers = {},
    customModsTiers = {},
    excludedItems = {}, // 추가: 제외된 아이템 목록 { category: [itemNames] }
    selectedLeague = "default",
    soundSettings = [], // 사용자가 설정한 사운드 매핑 (localStorage에서 전달, 배열 형태)
    lang = "ko", // 주석 언어 설정 (ko: 한국어, en: 영어)
  } = options;

  const isPS5 = soundOption === "ps5";
  const isSOnly = soundOption === "s_only";
  const isSilent = soundOption === "none";

  const preset = presets.presets.find((p) => p.id === presetId);
  if (!preset) {
    throw new Error(`Preset not found: ${presetId}`);
  }

  const lines = [];

  // 필터 헤더
  lines.push("# Filter generated by GAMEBOX");
  lines.push(`# Preset: ${preset.nameKo || preset.name}`);
  lines.push(`# Generated: ${new Date().toISOString()}`);
  lines.push("");

  // 리그 키 결정 (기본값은 normal 사용)
  const leagueKey = selectedLeague === "default" ? "normal" : selectedLeague;

  // 베이직 사운드 옵션 전달
  const soundContext = { soundOption, isPS5, isSOnly, isSilent, soundSettings };

  // 섹션: 레벨링 (최우선 - 화폐 및 베이스 아이템보다 먼저 처리)
  if (options.quickFilterSettings?.leveling) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 레벨링 | Leveling");
    lines.push("#######################################################");
    lines.push("");
    generateLevelingRules(
      lines,
      options.quickFilterSettings.leveling,
      lang
    );
  }

  // 섹션: 찬스 아이템 (베이스 아이템보다 우선 처리)
  if (options.quickFilterSettings?.chance?.enabled) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 찬스 아이템 | Chance Items");
    lines.push("#######################################################");
    lines.push("");
  }
  generateChanceRules(
    lines,
    preset,
    options.quickFilterSettings?.chance,
    soundContext,
    lang
  );

  // 섹션: 베이스 아이템 (장비 베이스)
  lines.push("");
  lines.push("#######################################################");
  lines.push("# 베이스 아이템 | Base Items");
  lines.push("#######################################################");
  lines.push("");
  generateGearRules(lines, preset, customGearTiers, excludedOptions, soundContext, excludedItems["gear-bases"] || [], lang);

  // 섹션: 미감정 아이템
  if (preset.rules.showUnidentified) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 미감정 아이템 | Unidentified Items");
    lines.push("#######################################################");
    lines.push("");
    generateUnidentifiedRules(lines, preset, customGearTiers, soundContext, lang);
  }

  // 섹션: 기타 (서판 등 - 화폐보다 우선 처리)
  if (options.quickFilterSettings?.others) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 기타 | Others");
    lines.push("#######################################################");
    lines.push("");
    generateOthersRules(
      lines,
      options.quickFilterSettings.others,
      lang
    );
  }

  // 섹션: 화폐
  lines.push("");
  lines.push("#######################################################");
  lines.push("# 화폐 | Currency");
  lines.push("#######################################################");
  lines.push("");
  generateCurrencyRules(lines, preset, customCurrencyTiers, leagueKey, soundContext, excludedItems["currency"] || [], lang, options.quickFilterSettings?.currency);

  // 섹션: 골드
  if (options.quickFilterSettings?.gold) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 골드 | Gold");
    lines.push("#######################################################");
    lines.push("");
    generateGoldRules(lines, options.quickFilterSettings.gold, lang);
  }

  // 섹션: 모드 티어
  lines.push("");
  lines.push("#######################################################");
  lines.push("# 모드 티어 | Mod Tiers");
  lines.push("#######################################################");
  lines.push("");
  generateModRules(lines, customModsTiers, soundContext, excludedItems["mods"] || [], lang);

  // 섹션: 레벨링 직업 선택
  if (options.quickFilterSettings?.levelingClassSelection) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 레벨링 직업 선택 | Leveling Class Selection");
    lines.push("#######################################################");
    lines.push("");
    generateLevelingClassSelectionRules(
      lines,
      options.quickFilterSettings.levelingClassSelection,
      lang
    );
  }

  // 섹션: 미가공 젬
  if (options.quickFilterSettings?.uncutGems) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 미가공 젬 | Uncut Gems");
    lines.push("#######################################################");
    lines.push("");
    generateUncutGemsRules(
      lines,
      options.quickFilterSettings.uncutGems,
      lang
    );
  }

  // 베이스 아이템 규칙 생성 (빠른 설정에서)
  if (options.quickFilterSettings?.baseItems) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 베이스 아이템 | Base Items");
    lines.push("#######################################################");
    lines.push("");
    generateBaseItemsRules(
      lines,
      options.quickFilterSettings.baseItems,
      lang
    );
  }

  // 섹션: 호신부
  if (options.quickFilterSettings?.charms) {
    lines.push("");
    lines.push("#######################################################");
    lines.push("# 호신부 | Charms");
    lines.push("#######################################################");
    lines.push("");
    generateCharmsRules(
      lines,
      options.quickFilterSettings.charms,
      lang
    );
  }

  return lines.join("\n");
}

/**
 * 레벨링 규칙 생성
 */
function generateLevelingRules(lines, levelingSettings, lang = "ko") {
  if (!levelingSettings || !levelingSettings.enabled) {
    return;
  }

  const rules = levelingSettings.rules || [];

  rules.forEach((rule) => {
    if (!rule.enabled) return;

    // 규칙 이름 주석
    const ruleName = lang === "ko" ? rule.nameKo || rule.name : rule.name;
    lines.push(`# ${ruleName}`);

    // RID 주석
    lines.push(`# [RID: ${rule.id}]`);

    // Show/Hide
    lines.push(rule.type === "hide" ? "Hide" : "Show");

    // Class 조건
    if (rule.conditions?.class) {
      const classValue = rule.conditions.class.value;
      if (Array.isArray(classValue)) {
        const classes = classValue.map((c) => `"${c}"`).join(" ");
        lines.push(`  Class == ${classes}`);
      } else {
        lines.push(`  Class == "${classValue}"`);
      }
    }

    // BaseType 조건 (복수 - baseTypes 배열)
    if (rule.conditions?.baseTypes && Array.isArray(rule.conditions.baseTypes)) {
      const baseTypes = rule.conditions.baseTypes.map((b) => `"${b}"`).join(" ");
      lines.push(`  BaseType == ${baseTypes}`);
    }

    // AreaLevel 조건
    if (rule.conditions?.areaLevel) {
      const { operator, value } = rule.conditions.areaLevel;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }

    // 스타일 적용
    if (rule.styles) {
      const styles = rule.styles;

      if (styles.fontSize) {
        lines.push(`  SetFontSize ${styles.fontSize}`);
      }

      if (styles.textColor) {
        const { r, g, b, a } = styles.textColor;
        lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.borderColor) {
        const { r, g, b, a } = styles.borderColor;
        lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.backgroundColor) {
        const { r, g, b, a } = styles.backgroundColor;
        lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.playEffect) {
        lines.push(`  PlayEffect ${styles.playEffect}`);
      }

      if (styles.minimapIcon) {
        const { size, color, shape } = styles.minimapIcon;
        lines.push(`  MinimapIcon ${size} ${color} ${shape}`);
      }

      if (styles.customSound) {
        lines.push(`  CustomAlertSound "${styles.customSound}" 300`);
      }
    }

    lines.push("");
  });
}

/**
 * 장비 규칙 생성
 */
function generateGearRules(
  lines,
  preset,
  customGearTiers,
  excludedOptions,
  soundContext,
  excludedItemsList = [],
  lang = "ko"
) {
  const { isSilent } = soundContext;
  const gearTiers = preset.rules.gearTiers || [];
  const minIlvl = preset.itemLevel.min;
  const useBaseMinIlvl = preset.itemLevel.useBaseMinIlvl;

  // 티어별로 그룹화
  const itemsByTier = {};
  gearTiers.forEach((tier) => {
    itemsByTier[tier] = [];
  });

  // 베이스 아이템을 티어별로 분류
  Object.keys(bases).forEach((itemName) => {
    const item = bases[itemName];
    let finalTier = item.tier || 4;

    // 커스텀 티어 확인
    if (customGearTiers[itemName]) {
      const customTier = customGearTiers[itemName];
      // S->1, A->2, B->3, C->4, D->5, E->6 변환
      const tierMap = { S: 1, A: 2, B: 3, C: 4, D: 5, E: 6 };
      finalTier = tierMap[customTier] || finalTier;
    }

    // 프리셋에서 지정한 티어에 포함되는지 확인
    if (gearTiers.includes(finalTier)) {
      if (!itemsByTier[finalTier]) {
        itemsByTier[finalTier] = [];
      }
      itemsByTier[finalTier].push({ name: itemName, ...item });
    }
  });

  // 티어별로 규칙 생성
  gearTiers.forEach((tier) => {
    // 커스텀 티어 반영 및 제외 항목 필터링
    const currentTierItems = (itemsByTier[tier] || [])
      .filter(item => !excludedItemsList.includes(item.name));
    if (currentTierItems.length === 0) return;

    // 클래스별로 그룹화
    const itemsByClass = {};
    currentTierItems.forEach((item) => {
      if (!itemsByClass[item.class]) {
        itemsByClass[item.class] = [];
      }
      itemsByClass[item.class].push(item);
    });

    // 클래스별로 규칙 생성
    Object.keys(itemsByClass).forEach((className) => {
      const classItems = itemsByClass[className];
      const baseTypes = classItems.map((item) => item.name);
      const capIlvl = classes[className]?.capIlvl;
      const classMinIlvl = classes[className]?.minIlvl;
      const presetId = preset.id;

      // T15+6모드의 경우 최소 레벨과 최대 레벨 두 규칙을 모두 생성
      if (
        tier === 1 &&
        presetId === "verystrict" &&
        capIlvl &&
        classMinIlvl !== null &&
        classMinIlvl !== undefined
      ) {
        // 최소 레벨 규칙 생성
        generateTier1Rule(
          lines,
          tier,
          className,
          baseTypes,
          classMinIlvl,
          capIlvl,
          preset,
          classItems,
          minIlvl,
          useBaseMinIlvl,
          soundContext,
          "min"
        );
        // 최대 레벨 규칙 생성
        generateTier1Rule(
          lines,
          tier,
          className,
          baseTypes,
          classMinIlvl,
          capIlvl,
          preset,
          classItems,
          minIlvl,
          useBaseMinIlvl,
          soundContext,
          "max"
        );
      } else {
        // 일반 규칙 생성
        generateTier1Rule(
          lines,
          tier,
          className,
          baseTypes,
          classMinIlvl,
          capIlvl,
          preset,
          classItems,
          minIlvl,
          useBaseMinIlvl,
          soundContext,
          null
        );
      }
    });
  });
}

/**
 * 1티어 규칙 생성 헬퍼 함수
 */
function generateTier1Rule(
  lines,
  tier,
  className,
  baseTypes,
  classMinIlvl,
  capIlvl,
  preset,
  classItems,
  minIlvl,
  useBaseMinIlvl,
  soundContext,
  levelType
) {
  const { isPS5, isSOnly, isSilent, soundSettings } = soundContext;
  // SECTION 주석
  lines.push(`# [SECTION: gear_bases]`);

  // RID 주석 (간단한 형식)
  const levelSuffix = levelType ? `_${levelType}` : "";
  lines.push(
    `# [RID: gear_bases_t${tier}_${className.toLowerCase()}${levelSuffix}]`
  );
  lines.push("Show");

  // ItemLevel 조건
  // 1티어의 경우 프리셋에 따라 최소/최대 레벨 조건이 다름
  if (tier === 1) {
    const presetId = preset.id;

    if (presetId === "starter" || presetId === "strict") {
      // 리그 스타터, T1-T14: 최소 레벨부터 최대 레벨까지 표시
      if (classMinIlvl !== null && classMinIlvl !== undefined) {
        lines.push(`  ItemLevel >= ${classMinIlvl}`);
      } else {
        lines.push(`  ItemLevel >= ${minIlvl}`);
      }
      // 최대 레벨 제한은 없음 (최소 레벨 이상이면 모두 표시)
    } else if (presetId === "verystrict") {
      // T15+6모드: 최소 레벨 또는 최대 레벨
      if (levelType === "min") {
        // 최소 레벨 규칙
        if (classMinIlvl !== null && classMinIlvl !== undefined) {
          lines.push(`  ItemLevel >= ${classMinIlvl}`);
        } else {
          lines.push(`  ItemLevel >= ${minIlvl}`);
        }
      } else if (levelType === "max") {
        // 최대 레벨 규칙
        if (capIlvl) {
          lines.push(`  ItemLevel >= ${capIlvl}`);
        }
      }
    } else if (presetId === "uber" || presetId === "vaal") {
      // Uber, Vaal: 최대 레벨만 표시
      if (capIlvl) {
        lines.push(`  ItemLevel >= ${capIlvl}`);
      } else if (classMinIlvl !== null && classMinIlvl !== undefined) {
        lines.push(`  ItemLevel >= ${classMinIlvl}`);
      } else {
        lines.push(`  ItemLevel >= ${minIlvl}`);
      }
    } else {
      // 기본값: 최대 레벨 사용
      if (capIlvl) {
        lines.push(`  ItemLevel >= ${capIlvl}`);
      } else if (classMinIlvl !== null && classMinIlvl !== undefined) {
        lines.push(`  ItemLevel >= ${classMinIlvl}`);
      } else {
        lines.push(`  ItemLevel >= ${minIlvl}`);
      }
    }
  } else {
    // 클래스별 최소 레벨 우선 사용
    if (classMinIlvl !== null && classMinIlvl !== undefined) {
      // 클래스에 최소 레벨이 있으면 사용
      lines.push(`  ItemLevel >= ${classMinIlvl}`);
    } else if (useBaseMinIlvl) {
      // 베이스별 최소 레벨 사용
      // 각 아이템마다 개별 규칙을 만들거나, 최소값을 사용
      const minBaseIlvl = Math.min(
        ...classItems.map((item) => {
          // bases.json에서 minIlvl이 있는지 확인
          return item.minIlvl || minIlvl;
        })
      );
      lines.push(`  ItemLevel >= ${minBaseIlvl}`);
    } else {
      // 프리셋의 전역 최소 레벨 사용
      lines.push(`  ItemLevel >= ${minIlvl}`);
    }
  }

  // Class 조건
  lines.push(`  Class == "${className}"`);

  // BaseType 조건
  if (baseTypes.length > 0) {
    const baseTypeLine = baseTypes.map((name) => `"${name}"`).join(" ");
    lines.push(`  BaseType == ${baseTypeLine}`);
  }

  // Rarity 조건
  if (tier === 3 && preset.rules.gearTier3Rarity) {
    lines.push(`  Rarity == ${preset.rules.gearTier3Rarity}`);
  } else if (!preset.rules.showNormalItems && !preset.rules.showMagicItems) {
    lines.push(`  Rarity == Rare`);
  }

  // TODO: 특출 아이템 처리
  // 특출: 1소켓이 2소켓으로, 2소켓이 3소켓으로 드롭되는 아이템
  // 특출 아이템 리스트를 받으면 여기에 조건 추가 예정
  // 예: Sockets >= 2 (1소켓 아이템이 2소켓 이상으로 드롭된 경우)

  // 스타일 적용
  const tierColors = getTierColors(tier);
  lines.push(`  SetFontSize ${tierColors.fontSize}`);
  lines.push(`  SetTextColor ${tierColors.textColor}`);
  lines.push(`  SetBorderColor ${tierColors.borderColor}`);
  lines.push(`  SetBackgroundColor ${tierColors.backgroundColor}`);

  // PlayEffect
  if (tierColors.playEffect) {
    lines.push(`  PlayEffect ${tierColors.playEffect}`);
  }

  // 사운드 (PS5 모드면 인게임 사운드로 변환, 아니면 커스텀 사운드)
  // 사운드 (PS5 모드면 인게임 사운드로 변환, 아니면 커스텀 사운드)
  // 기획 문서에 따른 1:1 매핑
  if (isSilent) {
    // 무음: 사운드 생성 안함
  } else if (isSOnly) {
    // S 티어만 듣기: 1티어(S 티어)인 경우에만 생성
    if (tier === 1) {
      if (isPS5) {
        const setting = soundSettings.find(s => s.id === `gear_t${tier}`);
        if (setting?.enabled && setting.ps5Slot) {
          lines.push(`  PlayAlertSound ${setting.ps5Slot} ${setting.volume || 300}`);
        }
      } else {
        const setting = soundSettings.find(s => s.id === `gear_t${tier}`);
        const file = setting?.pcFile || `custom_sound/5_item_t1.mp3`;
        const vol = setting?.volume || 300;
        if (setting?.enabled !== false) {
          lines.push(`  CustomAlertSound "${file}" ${vol}`);
        }
      }
    }
  } else if (isPS5) {
    const setting = soundSettings.find(s => s.id === `gear_t${tier}`);
    if (setting?.enabled && setting.ps5Slot) {
      lines.push(`  PlayAlertSound ${setting.ps5Slot} ${setting.volume || 300}`);
    }
  } else {
    // PC/커스텀 모드
    const setting = soundSettings.find(s => s.id === `gear_t${tier}`);
    if (setting?.enabled !== false) {
      const file = setting?.pcFile || tierColors.customSound;
      const vol = setting?.volume || 300;
      if (file) {
        lines.push(`  CustomAlertSound "${file}" ${vol}`);
      }
    }
  }

  lines.push("");
}

/**
 * 미감정 아이템 규칙 생성 (빛기둥)
 */
function generateUnidentifiedRules(lines, preset, customGearTiers, soundContext, lang = "ko") {
  const unidentifiedTiers = preset.rules.unidentifiedTiers || [];
  if (unidentifiedTiers.length === 0) return;

  const gearTiers = preset.rules.gearTiers || [];

  // 미감정 아이템은 1티어만 적용 (스크린샷 기준)
  if (!gearTiers.includes(1)) return;

  // 5등급: Red 빛기둥
  if (unidentifiedTiers.includes(5)) {
    generateUnidentifiedTierRule(
      lines,
      5,
      "Red",
      gearTiers,
      customGearTiers,
      soundContext
    );
  }

  // 4등급: Yellow 빛기둥
  if (unidentifiedTiers.includes(4)) {
    generateUnidentifiedTierRule(
      lines,
      4,
      "Yellow",
      gearTiers,
      customGearTiers,
      soundContext
    );
  }

  // 3등급 이하는 unidentifiedTiers에 포함되지 않으면 숨김 (별도 처리 불필요)
}

/**
 * 미감정 등급별 규칙 생성
 */
function generateUnidentifiedTierRule(
  lines,
  grade,
  effectColor,
  gearTiers,
  customGearTiers,
  soundContext
) {
  const { isSilent, isSOnly, isPS5 } = soundContext;
  // 1티어 아이템만 처리
  if (!gearTiers.includes(1)) return;

  // 1티어 아이템들을 클래스별로 그룹화
  const itemsByClass = {};

  Object.keys(bases).forEach((itemName) => {
    const item = bases[itemName];
    let finalTier = item.tier || 4;

    // 커스텀 티어 확인
    if (customGearTiers[itemName]) {
      const customTier = customGearTiers[itemName];
      const tierMap = { S: 1, A: 2, B: 3, C: 4, D: 5, E: 6 };
      finalTier = tierMap[customTier] || finalTier;
    }

    // 1티어만 처리
    if (finalTier === 1) {
      const className = item.class;
      if (!itemsByClass[className]) {
        itemsByClass[className] = [];
      }
      itemsByClass[className].push({ name: itemName, ...item });
    }
  });

  // 클래스별로 규칙 생성
  Object.keys(itemsByClass).forEach((className) => {
    const classItems = itemsByClass[className];
    const baseTypes = classItems.map((item) => item.name);
    const capIlvl = classes[className]?.capIlvl;

    // SECTION 주석
    lines.push(`# [SECTION: unidentified_items]`);

    // RID 주석
    lines.push(
      `# [RID: unidentified_grade${grade}_t1_${className.toLowerCase()}]`
    );
    lines.push("Show");

    // 미감정 등급 조건
    lines.push(`  UnidentifiedItemTier == ${grade}`);

    // 1티어는 최대 레벨(capIlvl) 이상만 표시
    if (capIlvl) {
      lines.push(`  ItemLevel >= ${capIlvl}`);
    }

    // Class 조건
    lines.push(`  Class == "${className}"`);

    // BaseType 조건
    if (baseTypes.length > 0) {
      const baseTypeLine = baseTypes.map((name) => `"${name}"`).join(" ");
      lines.push(`  BaseType == ${baseTypeLine}`);
    }

    // 빛기둥 효과 (PlayEffect)
    lines.push(`  PlayEffect ${effectColor}`);

    // 스타일은 기본값 사용 (또는 프리셋별로 다를 수 있음)
    // 여기서는 빛기둥만 강조하므로 기본 스타일 사용
    lines.push(`  SetFontSize 45`);
    lines.push(`  SetTextColor 255 255 255 255`);
    lines.push(`  SetBorderColor 255 255 255 255`);
    lines.push(`  SetBackgroundColor 0 0 0 255`);

    // TODO: 특출 아이템 처리
    // 특출: 1소켓이 2소켓으로, 2소켓이 3소켓으로 드롭되는 아이템
    // 특출 아이템 리스트를 받으면 여기에 조건 추가 예정
    // 예: Sockets >= 2 (1소켓 아이템이 2소켓 이상으로 드롭된 경우)

    lines.push("");
  });
}

function generateCurrencyRules(
  lines,
  preset,
  customCurrencyTiers,
  leagueKey,
  soundContext,
  excludedItemsList = [],
  lang = "ko",
  currencySettings = null
) {
  const { isPS5, isSOnly, isSilent, soundSettings } = soundContext;
  const currencyTierList = preset.rules.currencyTiers || [];
  const tierMapping = { S: "S", A: "A", B: "B", C: "C", D: "D", E: "E" };

  // 커스텀 화폐 규칙 생성 (StackSize 등)
  if (currencySettings && currencySettings.enabled && currencySettings.rules) {
    currencySettings.rules.forEach((rule) => {
      if (!rule.enabled) return;

      const ruleName = lang === "ko" ? rule.nameKo || rule.name : rule.name;
      lines.push(`# ${ruleName}`);
      lines.push(`# [RID: ${rule.id}]`);
      lines.push("Show"); // 항상 Show

      if (rule.conditions) {
        // StackSize
        if (rule.conditions.stackSize) {
           const { operator, value } = rule.conditions.stackSize;
           lines.push(`  StackSize ${operator} ${value}`);
        }
        // Class
        if (rule.conditions.class) {
           const { operator, value } = rule.conditions.class;
           if (Array.isArray(value)) {
             const classes = value.map(c => `"${c}"`).join(" ");
             lines.push(`  Class ${operator} ${classes}`);
           } else {
             lines.push(`  Class ${operator} "${value}"`);
           }
        }
        // BaseType
        if (rule.conditions.baseType) {
           const { operator, value } = rule.conditions.baseType;
           if (Array.isArray(value)) {
             const bases = value.map(b => `"${b}"`).join(" ");
             lines.push(`  BaseType ${operator} ${bases}`);
           } else {
             lines.push(`  BaseType ${operator} "${value}"`);
           }
        }
        // AreaLevel
        if (rule.conditions.areaLevel) {
           const { operator, value } = rule.conditions.areaLevel;
           lines.push(`  AreaLevel ${operator} ${value}`);
        }
      }

      // Styles
      if (rule.styles) {
        const styles = rule.styles;
        if (styles.fontSize) lines.push(`  SetFontSize ${styles.fontSize}`);
        if (styles.textColor) {
            const { r, g, b, a } = styles.textColor;
            lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
        }
        if (styles.borderColor) {
            const { r, g, b, a } = styles.borderColor;
            lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
        }
        if (styles.backgroundColor) {
            const { r, g, b, a } = styles.backgroundColor;
            lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
        }
        if (styles.playEffect) lines.push(`  PlayEffect ${styles.playEffect}`);
        if (styles.minimapIcon) {
            const { size, color, shape } = styles.minimapIcon;
            if (size !== null) lines.push(`  MinimapIcon ${size} ${color || "White"} ${shape || "Circle"}`);
        }
        if (styles.customSound) lines.push(`  CustomAlertSound "${styles.customSound}" ${styles.soundVolume || 300}`);
      }
      lines.push("");
    });
  }

  // 리그별 화폐 데이터 가져오기
  const leagueCurrencyData =
    currencyTiers[leagueKey] || currencyTiers.normal || {};

  currencyTierList.forEach((tier) => {
    const tierKey = tierMapping[tier] || tier;
    let currencyItems = leagueCurrencyData[tierKey] || [];

    // 커스텀 티어 적용 및 제외 항목 필터링
    const finalItems = currencyItems.filter((itemName) => {
      // 먼저 제외 항목 리스트에 있는지 확인
      if (excludedItemsList.includes(itemName)) {
        return false;
      }
      // 그 다음 커스텀 티어 확인
      const customTier = customCurrencyTiers[itemName]?.[leagueKey];
      if (customTier) {
        return customTier === tier;
      }
      return true; // 커스텀 티어가 없으면 기본 티어 사용
    });

    if (finalItems.length === 0) return;

    // 아이템들을 클래스별로 그룹화
    const itemsByClass = {};
    finalItems.forEach((itemName) => {
      let itemClass = "Stackable Currency"; // 기본값

      // 클래스 매핑
      if (currencyItemCategories.lineage_gems.includes(itemName)) {
        itemClass = "Support Gems";
      } else if (currencyItemCategories.ritual_omen.includes(itemName)) {
        itemClass = "Omen";
      } else if (currencyItemCategories.waystones.includes(itemName)) {
        itemClass = "Waystones";
      } else if (currencyItemCategories.jewels.includes(itemName)) {
        itemClass = "Jewels";
      } else if (currencyItemCategories.charm.includes(itemName)) {
        itemClass = "Charms";
      } else if (currencyItemCategories.soul_cores.includes(itemName)) {
        itemClass = "Soul Core";
      } else if (currencyItemCategories.idosl.includes(itemName)) {
        itemClass = "Augment";
      } else if (itemName.includes("Uncut Skill Gem")) {
        itemClass = "Skill Gems";
      } else if (itemName.includes("Uncut Spirit Gem")) {
        itemClass = "Spirit Gems";
      } else if (currencyItemCategories.flask.includes(itemName)) {
        itemClass = "Flasks";
      }

      if (!itemsByClass[itemClass]) {
        itemsByClass[itemClass] = [];
      }
      itemsByClass[itemClass].push(itemName);
    });

    // 클래스별로 규칙 생성
    Object.keys(itemsByClass).forEach((itemClass) => {
      const classItems = itemsByClass[itemClass];

      // SECTION 주석
      lines.push(`# [SECTION: currency]`);

      // RID 주석
      lines.push(
        `# [RID: currency_${tierKey.toLowerCase()}_${itemClass
          .toLowerCase()
          .replace(/\s+/g, "_")}]`
      );
      lines.push("Show");

      // Class 조건
      lines.push(`  Class == "${itemClass}"`);

      // BaseType 조건
      const baseTypeLine = classItems.map((name) => `"${name}"`).join(" ");
      lines.push(`  BaseType == ${baseTypeLine}`);

      // 스타일 적용
      const tierColors = getCurrencyTierColors(tierKey);
      lines.push(`  SetFontSize ${tierColors.fontSize}`);
      lines.push(`  SetTextColor ${tierColors.textColor}`);
      lines.push(`  SetBorderColor ${tierColors.borderColor}`);
      lines.push(`  SetBackgroundColor ${tierColors.backgroundColor}`);

      // PlayEffect
      if (tierColors.playEffect) {
        lines.push(`  PlayEffect ${tierColors.playEffect}`);
      }

      // MinimapIcon
      if (tierColors.minimapIcon) {
        lines.push(`  MinimapIcon ${tierColors.minimapIcon}`);
      }

      // 사운드 (PS5 모드면 인게임 사운드로 변환, 아니면 커스텀 사운드)
      let settingId = `currency_${tierKey.toLowerCase()}`;
      if (itemClass === "Waystones") settingId = "waystones";
      if (itemClass === "Flasks") settingId = "flasks";
      // 중첩 화폐는 별도 처리가 필요할 수 있으나 현재는 티어별로 처리됨
      // 만약 "화폐 중첩" 설정을 쓰고 싶다면 조건 추가 필요

      const setting = soundSettings.find(s => s.id === settingId);

      if (isSilent) {
        // 무음: 사운드 생성 안함
      } else if (isSOnly) {
        // S 티어만 듣기
        if (tierKey === "S") {
          if (isPS5) {
            const slot = setting?.ps5Slot || 5;
            const vol = setting?.volume || 300;
            if (setting?.enabled !== false) {
              lines.push(`  PlayAlertSound ${slot} ${vol}`);
            }
          } else {
            const file = setting?.pcFile || "custom_sound/1_currency_s.mp3";
            const vol = setting?.volume || 300;
            if (setting?.enabled !== false) {
              lines.push(`  CustomAlertSound "${file}" ${vol}`);
            }
          }
        }
      } else if (isPS5) {
        if (setting?.enabled && setting.ps5Slot) {
          lines.push(`  PlayAlertSound ${setting.ps5Slot} ${setting.volume || 300}`);
        } else if (!setting && ["S", "A", "B", "C"].includes(tierKey)) {
          // 기본 매핑 fallback
          const ps5SoundMap = { S: 5, A: 1, B: 2, C: 2 };
          lines.push(`  PlayAlertSound ${ps5SoundMap[tierKey]} 300`);
        }
      } else {
        // PC/커스텀 사운드
        if (setting?.enabled !== false) {
          const file = setting?.pcFile || tierColors.customSound;
          const vol = setting?.volume || 300;
          if (file) {
            lines.push(`  CustomAlertSound "${file}" ${vol}`);
          }
        }
      }

      lines.push("");
    });
  });
}

/**
 * 장비 티어별 색상 및 스타일
 */
function getTierColors(tier) {
  const tierStyles = {
    1: {
      fontSize: 45,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "255 255 255 255",
      playEffect: "Red",
      customSound: "custom_sound/1_gear_t1.mp3",
    },
    2: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "204 90 138 255",
      playEffect: "Orange",
      customSound: "custom_sound/2_gear_t2.mp3",
    },
    3: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "205 82 80 255",
      playEffect: "Yellow",
      customSound: "custom_sound/3_gear_t3.mp3",
    },
    4: {
      fontSize: 42,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "255 165 0 255",
      playEffect: null,
      customSound: "custom_sound/4_gear_t4.mp3",
    },
  };

  return tierStyles[tier] || tierStyles[4];
}

/**
 * 화폐 티어별 색상 및 스타일
 */
function getCurrencyTierColors(tier) {
  const tierStyles = {
    S: {
      fontSize: 45,
      textColor: "255 0 0 255",
      borderColor: "255 0 0 255",
      backgroundColor: "255 255 255 255",
      playEffect: "Red",
      minimapIcon: "0 Red Star",
      customSound: "custom_sound/1_currency_s.mp3",
    },
    A: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "240 35 120 255",
      playEffect: "Orange",
      minimapIcon: "0 Orange Circle",
      customSound: "custom_sound/2_currency_a.mp3",
    },
    B: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "240 90 35 255",
      playEffect: "Yellow",
      minimapIcon: "1 Yellow Circle",
      customSound: "custom_sound/3_currency_b.mp3",
    },
    C: {
      fontSize: 42,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "249 150 255 255",
      playEffect: null,
      minimapIcon: "1 Yellow Circle",
      customSound: "custom_sound/4_currency_c.mp3",
    },
    D: {
      fontSize: 42,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "210 178 135 255",
      playEffect: null,
      minimapIcon: null,
      customSound: null,
    },
    E: {
      fontSize: 38,
      textColor: "220 175 132 255",
      borderColor: "0 0 0 255",
      backgroundColor: "0 0 0 255",
      playEffect: null,
      minimapIcon: null,
      customSound: null,
    },
  };

  return tierStyles[tier] || tierStyles.D;
}

/**
 * 골드 규칙 생성
 */
function generateGoldRules(lines, goldSettings, lang = "ko") {
  // 골드가 비활성화되어 있으면 모든 규칙을 Hide로 생성
  // enabled가 undefined일 경우 기본값 true로 처리
  const shouldHideAll = goldSettings.enabled === false;

  goldSettings.rules.forEach((rule) => {
    // 골드가 비활성화되어 있거나 개별 규칙이 비활성화되어 있으면 Hide로 변경
    const shouldHide = shouldHideAll || !rule.enabled;

    if (shouldHide) {
      // 비활성화된 경우 코드 자체를 생성하지 않음 (사용자 요청 사항)
      // Hide 규칙을 생성하고 싶으면 모달에서 "Hide" 타입을 선택해야 함
      return;
    }

    // 제목을 주석으로 추가 (언어 설정에 따라)
    const title = lang === "ko" 
      ? (rule.nameKo || rule.name) 
      : (rule.nameEn || rule.name);
    if (title) {
      lines.push(`# ${title}`);
    }

    // RID 주석
    lines.push(`# [RID: ${rule.id}]`);

    // Show/Hide
    lines.push(rule.type === "hide" ? "Hide" : "Show");

    // Class 조건 (골드는 일반적으로 "Stackable Currency" 또는 "Currency")
    // 기본값 규칙은 "Currency", 나머지는 "Stackable Currency"
    if (rule.id === "gold_default") {
      lines.push(`  Class == "Currency"`);
    } else {
      lines.push(`  Class == "Stackable Currency"`);
    }

    // BaseType 조건
    lines.push(`  BaseType == "골드"`);

    // AreaLevel 조건
    if (rule.conditions?.areaLevel) {
      const { operator, value } = rule.conditions.areaLevel;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }

    // StackSize 조건
    if (rule.conditions?.stackSize) {
      const { operator, value } = rule.conditions.stackSize;
      lines.push(`  StackSize ${operator} ${value}`);
    }

    // 스타일 적용 (Show 타입만, Hide로 변경된 경우 스타일 적용 안함)
    if (!shouldHide && rule.type === "show" && rule.styles) {
      if (rule.styles.fontSize) {
        lines.push(`  SetFontSize ${rule.styles.fontSize}`);
      }

      if (rule.styles.textColor) {
        const { r, g, b, a } = rule.styles.textColor;
        lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
      }

      if (rule.styles.borderColor) {
        const { r, g, b, a } = rule.styles.borderColor;
        lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
      }

      if (rule.styles.backgroundColor) {
        const { r, g, b, a } = rule.styles.backgroundColor;
        lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
      }

      if (rule.styles.playEffect) {
        lines.push(`  PlayEffect ${rule.styles.playEffect}`);
      }
    }

    lines.push("");
  });
}

/**
 * 찬스 아이템 규칙 생성
 */
function generateChanceRules(lines, preset, chanceSettings, soundContext, lang = "ko") {
  const { isPS5, isSOnly, isSilent } = soundContext;
  // 빠른 설정에서 체크해제했으면 Hide, 기본값은 Show
  const isEnabled = chanceSettings?.enabled !== false; // 기본값 true
  const showHide = isEnabled ? "Show" : "Hide";

  // SECTION 주석
  lines.push("#==================================================");
  lines.push("# [SECTION: chance]");
  lines.push("# 찬스 아이템 | Chance Base");
  lines.push("#==================================================");
  lines.push("");

  // RID 주석
  lines.push("# 찬스 아이템");
  lines.push("# [RID: chance_base]");
  lines.push(showHide);

  // 조건
  lines.push(`  BaseType == "Timeless Jewel" "Silver Charm" "Heavy Belt"`);
  lines.push(`  Rarity == Normal`);
  lines.push(`  Corrupted False`);

  // 스타일
  lines.push(`  SetFontSize 45`);
  lines.push(`  SetTextColor 255 0 0 255 #빨강`);
  lines.push(`  SetBorderColor 255 0 0 255 #빨강`);
  lines.push(`  SetBackgroundColor 31 12 8 255 #붉은색계열 블랙`);
  lines.push(`  MinimapIcon 2 Brown Kite`);

  // 사운드 처리
  const presetId = preset.id;
  // Vaal 프리셋에서는 A티어 이하 사운드 제거이므로 사운드 코드 제거
  if (presetId !== "vaal") {
    if (isSilent || isSOnly) {
      // 찬스는 S 티어가 아니므로 S 티어 전용 모드에서는 생성 안함
    } else if (isPS5) {
      // PS5 모드: CustomAlertSound → PlayAlertSound 1 300
      lines.push(`  PlayAlertSound 1 300`);
    } else {
      // PC 모드: CustomAlertSound 사용
      lines.push(`  CustomAlertSound "custom_sound/2_currency_a.mp3" 300`);
    }
  }
  // Vaal 프리셋에서는 사운드 코드를 추가하지 않음

  lines.push("");
}

/**
 * 레벨링 직업 선택 규칙 생성
 */
function generateLevelingClassSelectionRules(lines, levelingClassSelection, lang = "ko") {
  // 활성화되지 않았으면 규칙 생성 안함
  if (!levelingClassSelection.enabled) {
    return;
  }

  // SECTION 주석 (언어별)
  lines.push("#==================================================");
  lines.push("# [SECTION: leveling_class_selection]");
  lines.push(lang === "ko" ? "# 레벨링 직업 선택" : "# Leveling Class Selection");
  lines.push("#==================================================");
  lines.push("");

  // 무기 규칙 생성
  if (levelingClassSelection.weaponTypes.length > 0) {
    generateLevelingWeaponRule(
      lines,
      levelingClassSelection,
      "gear-leveling-weapons"
    );
  }

  // 방어구 규칙 생성
  if (levelingClassSelection.armourTypes.length > 0) {
    generateLevelingArmourRule(
      lines,
      levelingClassSelection,
      "gear-leveling-armour"
    );
  }
}

/**
 * 레벨링 무기 규칙 생성
 */
function generateLevelingWeaponRule(
  lines,
  levelingClassSelection,
  ruleIdPrefix
) {
  const weaponTypeMap = {
    spears: "Spears",
    talismans: "Talismans",
    quarterstaves: "Quarterstaves",
    sceptres: "Sceptres",
    wands: "Wands",
    staves: "Staves",
    bows: "Bows",
    quivers: "Quivers",
    crossbows: "Crossbows",
    one_hand_maces: "One Hand Maces",
    two_hand_maces: "Two Hand Maces",
    foci: "Foci",
  };

  const classNames = levelingClassSelection.weaponTypes
    .map((type) => weaponTypeMap[type])
    .filter(Boolean)
    .map((name) => `"${name}"`)
    .join(" ");

  if (!classNames) return;

  // Rarity별로 규칙 생성
  const rarityTypes = [];
  if (levelingClassSelection.rarity.rare) {
    rarityTypes.push({ type: "Rare", id: "rare" });
  }
  if (levelingClassSelection.rarity.magic) {
    rarityTypes.push({ type: "Magic", id: "magic" });
  }
  if (levelingClassSelection.rarity.normal) {
    rarityTypes.push({ type: "Normal", id: "normal" });
  }

  if (rarityTypes.length === 0) return;

  rarityTypes.forEach((rarity) => {
    // 제목 주석
    lines.push(
      `# ${rarity.type} Leveling Weapons (${ruleIdPrefix}-${rarity.id})`
    );

    // RID 주석
    lines.push(`# [RID: ${ruleIdPrefix}-${rarity.id}]`);

    // Show
    lines.push("Show");

    // AreaLevel 조건
    lines.push("  AreaLevel <= 65");

    // Class 조건 (무기 클래스들)
    lines.push(`  Class == ${classNames}`);

    // Rarity 조건
    lines.push(`  Rarity == ${rarity.type}`);

    // 스타일 (예시: White 효과)
    lines.push("  PlayEffect White");
    lines.push("  MinimapIcon 2 White Kite");

    lines.push("");
  });
}

/**
 * 레벨링 방어구 규칙 생성
 */
function generateLevelingArmourRule(
  lines,
  levelingClassSelection,
  ruleIdPrefix
) {
  // 방어구 타입별 BaseArmour, BaseEvasion, BaseEnergyShield 조건
  const armourTypeConditions = {
    AR: {
      baseArmour: ">= 1",
      baseEvasion: "== 0",
      baseEnergyShield: "== 0",
    },
    ES: {
      baseArmour: "== 0",
      baseEvasion: "== 0",
      baseEnergyShield: ">= 1",
    },
    EV: {
      baseArmour: "== 0",
      baseEvasion: ">= 1",
      baseEnergyShield: "== 0",
    },
    "AR/ES": {
      baseArmour: ">= 1",
      baseEvasion: "== 0",
      baseEnergyShield: ">= 1",
    },
    "AR/EV": {
      baseArmour: ">= 1",
      baseEvasion: ">= 1",
      baseEnergyShield: "== 0",
    },
    "EV/ES": {
      baseArmour: "== 0",
      baseEvasion: ">= 1",
      baseEnergyShield: ">= 1",
    },
    "AR/EV/ES": {
      baseArmour: ">= 1",
      baseEvasion: ">= 1",
      baseEnergyShield: ">= 1",
    },
  };

  // 방어구 Class 목록
  const armourClasses = [
    "Body Armours",
    "Boots",
    "Gloves",
    "Helmets",
    "Shields",
  ]
    .map((name) => `"${name}"`)
    .join(" ");

  // Rarity별로 규칙 생성
  const rarityTypes = [];
  if (levelingClassSelection.rarity.rare) {
    rarityTypes.push({ type: "Rare", id: "rare" });
  }
  if (levelingClassSelection.rarity.magic) {
    rarityTypes.push({ type: "Magic", id: "magic" });
  }
  if (levelingClassSelection.rarity.normal) {
    rarityTypes.push({ type: "Normal", id: "normal" });
  }

  if (rarityTypes.length === 0) return;

  // 방어구 타입별로 규칙 생성
  levelingClassSelection.armourTypes.forEach((armourType) => {
    const conditions = armourTypeConditions[armourType];
    if (!conditions) return;

    rarityTypes.forEach((rarity) => {
      // 제목 주석
      lines.push(
        `# ${rarity.type} Leveling Armour (${ruleIdPrefix}-${rarity.id})`
      );

      // RID 주석
      lines.push(
        `# [RID: ${ruleIdPrefix}-${armourType.toLowerCase()}-${rarity.id}]`
      );

      // Show
      lines.push("Show");

      // BaseArmour 조건
      lines.push(`  BaseArmour ${conditions.baseArmour}`);

      // BaseEvasion 조건
      lines.push(`  BaseEvasion ${conditions.baseEvasion}`);

      // BaseEnergyShield 조건
      lines.push(`  BaseEnergyShield ${conditions.baseEnergyShield}`);

      // AreaLevel 조건
      lines.push("  AreaLevel <= 65");

      // Class 조건 (방어구 클래스들)
      lines.push(`  Class == ${armourClasses}`);

      // Rarity 조건
      lines.push(`  Rarity == ${rarity.type}`);

      // 스타일 (예시: White 효과)
      lines.push("  PlayEffect White");
      lines.push("  MinimapIcon 2 White Kite");

      lines.push("");
    });
  });
}

// 모드 티어 규칙 생성
function generateModRules(lines, customModsTiers, soundContext, excludedItemsList = [], lang = "ko") {
  if (!modsTiersData || !modsTiersData.groups) return;

  lines.push("############################################################");
  lines.push(lang === "ko" ? "## 모드 티어 (커스텀 하이라이트)" : "## Mod Tiers (Custom Highlight)");
  lines.push("############################################################");

  // 티어별로 처리 (A부터 순서대로)
  ["A", "B", "C"].forEach(tier => {
    // 해당 티어에 속하는 모드 그룹들 찾기
    let groupIds = modsTiersData[tier] || [];

    // 커스텀 티어 반영 (다른 티어에서 이 티어로 이동해온 모드들)
    Object.keys(customModsTiers).forEach(modId => {
      if (customModsTiers[modId] === tier && !groupIds.includes(modId)) {
        groupIds.push(modId);
      }
    });

    // 이 티어에서 다른 티어로 이동한 모드 그룹 제외
    // 그리고 excludedItemsList에 있는 모드 그룹 제외
    const finalGroupIds = groupIds.filter(modId => {
      const customTier = customModsTiers[modId];
      return (!customTier || customTier === tier) && !excludedItemsList.includes(modId);
    });

    if (finalGroupIds.length === 0) return;

    lines.push(`# Mod Tier ${tier}`);
    
    finalGroupIds.forEach(groupId => {
      const modGroup = modsTiersData.groups?.[groupId];
      if (!modGroup) return;

      // 해당 그룹의 모든 티어 이름을 가져옴 (사용자가 "Crystalising" 같은 이름을 원함)
      const tierNames = modGroup.tiers.map(t => `"${t.nameEn}"`).join(" ");
      
      lines.push("Show");
      lines.push(`    HasExplicitMod ${tierNames}`);
      
      // 티어별 스타일 적용
      const styles = getModTierStyles(tier);
      if (styles.fontSize) lines.push(`    SetFontSize ${styles.fontSize}`);
      if (styles.textColor) lines.push(`    SetTextColor ${styles.textColor}`);
      if (styles.backgroundColor) lines.push(`    SetBackgroundColor ${styles.backgroundColor}`);
      if (styles.borderColor) lines.push(`    SetBorderColor ${styles.borderColor}`);
      
      // 사운드 처리
      if (!soundContext.isSilent) {
        if (tier === "A") {
          lines.push("    PlayAlertSound 1 300");
          lines.push("    PlayEffect Red");
          lines.push("    MinimapIcon 0 Red Star");
        } else if (tier === "B") {
          lines.push("    PlayAlertSound 2 300");
          lines.push("    PlayEffect Orange");
          lines.push("    MinimapIcon 1 Orange Circle");
        }
      }
    });
    lines.push("");
  });
}

// 모드 티어별 스타일 정의
function getModTierStyles(tier) {
  switch (tier) {
    case "S":
      return { fontSize: 45, textColor: "255 0 0", borderColor: "255 0 0", backgroundColor: "255 255 255 200" };
    case "A":
      return { fontSize: 40, textColor: "255 128 0", borderColor: "255 128 0" };
    case "B":
      return { fontSize: 35, textColor: "255 255 0", borderColor: "255 255 0" };
    case "C":
      return { fontSize: 30, textColor: "200 200 200" };
    default:
      return { fontSize: 32 };
  }
}

/**
 * 미가공 젬 규칙 생성
 */
function generateUncutGemsRules(lines, uncutGemsSettings, lang = "ko") {
  if (uncutGemsSettings.enabled === false) {
    return;
  }

  uncutGemsSettings.rules.forEach((rule) => {
    if (!rule.enabled) {
      return;
    }

    // 제목 주석
    const title = lang === "ko" ? rule.nameKo || rule.name : rule.name;
    lines.push(`# ${title}`);

    // RID 주석
    lines.push(`# [RID: ${rule.id}]`);

    // Show
    lines.push(rule.type === "hide" ? "Hide" : "Show");

    // Class 조건
    if (rule.conditions?.class) {
      const classValue = rule.conditions.class.value;
      if (Array.isArray(classValue)) {
        const classes = classValue.map((c) => `"${c}"`).join(" ");
        lines.push(`  Class == ${classes}`);
      } else {
        lines.push(`  Class == "${classValue}"`);
      }
    }

    // BaseType 조건
    if (rule.conditions?.baseType) {
      const baseTypeValue = rule.conditions.baseType.value;
      if (Array.isArray(baseTypeValue)) {
        const baseTypes = baseTypeValue.map((b) => `"${b}"`).join(" ");
        lines.push(`  BaseType == ${baseTypes}`);
      } else {
        lines.push(`  BaseType == "${baseTypeValue}"`);
      }
    }

    // AreaLevel 조건
    if (rule.conditions?.areaLevel) {
      const { operator, value } = rule.conditions.areaLevel;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }

    // 스타일 적용
    if (rule.type === "show" && rule.styles) {
      const styles = rule.styles;

      if (styles.fontSize) {
        lines.push(`  SetFontSize ${styles.fontSize}`);
      }

      if (styles.textColor) {
        const { r, g, b, a } = styles.textColor;
        lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.borderColor) {
        const { r, g, b, a } = styles.borderColor;
        lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.backgroundColor) {
        const { r, g, b, a } = styles.backgroundColor;
        lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.playEffect) {
        lines.push(`  PlayEffect ${styles.playEffect}`);
      }

      if (styles.minimapIcon) {
        const { size, color, shape } = styles.minimapIcon;
        if (size !== null || color !== null || shape !== null) {
          lines.push(`  MinimapIcon ${size || 0} ${color || "White"} ${shape || "Circle"}`);
        }
      }

      if (styles.customSound) {
        lines.push(`  CustomAlertSound "${styles.customSound}" 300`);
      }
    }

    lines.push("");
  });
}
/**
 * 베이스 아이템 규칙 생성 (목걸이/반지/벨트 등)
 */
function generateBaseItemsRules(lines, baseItemsSettings, lang = "ko") {
  if (baseItemsSettings.enabled === false) {
    return;
  }

  baseItemsSettings.rules.forEach((rule) => {
    if (!rule.enabled) {
      return;
    }

    // jewellery 규칙만 처리 (다른 규칙은 기존 gear 규칙에서 처리)
    if (rule.id !== "base_items_jewellery") {
      return;
    }

    // 제목 주석
    const title = lang === "ko" ? rule.nameKo || rule.name : rule.name;
    lines.push(`# ${title}`);

    // 규칙 ID 주석
    lines.push(`# [RID: Jewellery_]`);

    // Show/Hide
    lines.push(rule.type === "hide" ? "Hide" : "Show");

    // UnidentifiedItemTier 조건
    if (rule.conditions?.unidentifiedItemTier) {
      const { operator, value } = rule.conditions.unidentifiedItemTier;
      lines.push(`  UnidentifiedItemTier ${operator} ${value}`);
    }

    // Class 조건
    if (rule.conditions?.class) {
      const classValue = rule.conditions.class.value;
      if (Array.isArray(classValue)) {
        const classes = classValue.map(c => `"${c}"`).join(" ");
        lines.push(`  Class ${classes}`);
      } else {
        lines.push(`  Class "${classValue}"`);
      }
    }

    // itemTier 조건에 따른 BaseType 필터링
    if (rule.conditions?.itemTier?.value && rule.conditions.itemTier.value !== "all") {
      const tier = rule.conditions.itemTier.value;
      // T1/T2 목걸이/반지/벨트 베이스 타입 목록
      const tierBaseTypes = {
        "T1": ["Gold Amulet", "Lunar Amulet", "Ruby Ring", "Emerald Ring", "Iron Ring", "Prismatic Ring", "Plate Belt", "Mail Belt"],
        "T2": ["Amber Amulet", "Bloodstone Amulet", "Jade Tiara", "Sapphire Ring", "Topaz Ring", "Fine Belt", "Linen Belt"]
      };
      
      if (tierBaseTypes[tier]) {
        const bases = tierBaseTypes[tier].map(b => `"${b}"`).join(" ");
        lines.push(`  BaseType ${bases}`);
      }
    }

    // Rarity 조건
    if (rule.conditions?.rarity) {
      const { operator, value } = rule.conditions.rarity;
      if (operator === ">=" && value === "Normal") {
        lines.push(`  Rarity Normal Magic Rare`);
      } else if (operator === ">=") {
        lines.push(`  Rarity ${operator} ${value}`);
      } else {
        lines.push(`  Rarity ${value}`);
      }
    }

    // 스타일 적용
    const styles = rule.styles || {};
    
    if (styles.fontSize) {
      lines.push(`  SetFontSize ${styles.fontSize}`);
    }
    if (styles.textColor) {
      const { r, g, b, a } = styles.textColor;
      lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
    }
    if (styles.borderColor) {
      const { r, g, b, a } = styles.borderColor;
      lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
    }
    if (styles.backgroundColor) {
      const { r, g, b, a } = styles.backgroundColor;
      lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
    }
    if (styles.playEffect) {
      lines.push(`  PlayEffect ${styles.playEffect}`);
    }
    if (styles.minimapIcon) {
      const { size, color, shape } = styles.minimapIcon;
      if (size !== null && size !== undefined) {
        lines.push(`  MinimapIcon ${size} ${color || "Orange"} ${shape || "Kite"}`);
      }
    }
    if (styles.playAlertSound) {
      const { id, volume } = styles.playAlertSound;
      lines.push(`  PlayAlertSound ${id} ${volume}`);
    }
    if (styles.customSound) {
      lines.push(`  CustomAlertSound "${styles.customSound}"`);
      if (styles.soundVolume) {
        lines.push(`  CustomAlertSoundOptional ${styles.soundVolume}`);
      }
    }

    lines.push("");
  });
}

/**
 * 호신부 규칙 생성
 */
function generateCharmsRules(lines, charmsSettings, lang = "ko") {
  if (charmsSettings.enabled === false) {
    return;
  }

  charmsSettings.rules.forEach((rule) => {
    if (!rule.enabled) {
      return;
    }

    // 제목 주석
    const title = lang === "ko" ? rule.nameKo || rule.name : rule.name;
    lines.push(`# ${title}`);

    // 규칙 ID 주석
    lines.push(`# [RID: ${rule.id}]`);

    // Show/Hide
    lines.push(rule.type === "hide" ? "Hide" : "Show");

    // ItemLevel 조건
    if (rule.conditions?.itemLevel) {
      const { operator, value } = rule.conditions.itemLevel;
      lines.push(`  ItemLevel ${operator} ${value}`);
    }

    // Mirrored 조건
    if (rule.conditions?.mirrored !== undefined) {
      const value = rule.conditions.mirrored.value;
      lines.push(`  Mirrored ${value ? "True" : "False"}`);
    }

    // Corrupted 조건
    if (rule.conditions?.corrupted !== undefined) {
      const value = rule.conditions.corrupted.value;
      lines.push(`  Corrupted ${value ? "True" : "False"}`);
    }

    // AreaLevel 조건 (단일)
    if (rule.conditions?.areaLevel) {
      const { operator, value } = rule.conditions.areaLevel;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }

    // AreaLevel Min/Max 조건 (범위)
    if (rule.conditions?.areaLevelMin) {
      const { operator, value } = rule.conditions.areaLevelMin;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }
    if (rule.conditions?.areaLevelMax) {
      const { operator, value } = rule.conditions.areaLevelMax;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }

    // Class 조건
    if (rule.conditions?.class) {
      const classValue = rule.conditions.class.value;
      if (Array.isArray(classValue)) {
        const classes = classValue.map(c => `"${c}"`).join(" ");
        lines.push(`  Class == ${classes}`);
      } else {
        lines.push(`  Class == "${classValue}"`);
      }
    }

    // BaseType 조건
    if (rule.conditions?.baseType) {
      const baseValue = rule.conditions.baseType.value;
      if (Array.isArray(baseValue)) {
        const bases = baseValue.map(b => `"${b}"`).join(" ");
        lines.push(`  BaseType == ${bases}`);
      } else {
        lines.push(`  BaseType == "${baseValue}"`);
      }
    }

    // Rarity 조건
    if (rule.conditions?.rarity) {
      const { operator, value } = rule.conditions.rarity;
      if (Array.isArray(value)) {
        lines.push(`  Rarity ${value.join(" ")}`);
      } else if (operator === ">=") {
        lines.push(`  Rarity ${operator} ${value}`);
      } else {
        lines.push(`  Rarity ${value}`);
      }
    }

    // 스타일 적용
    const styles = rule.styles || {};
    
    if (styles.fontSize) {
      lines.push(`  SetFontSize ${styles.fontSize}`);
    }
    if (styles.textColor) {
      const { r, g, b, a } = styles.textColor;
      lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
    }
    if (styles.borderColor) {
      const { r, g, b, a } = styles.borderColor;
      lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
    }
    if (styles.backgroundColor) {
      const { r, g, b, a } = styles.backgroundColor;
      lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
    }
    if (styles.playEffect) {
      lines.push(`  PlayEffect ${styles.playEffect}`);
    }
    if (styles.minimapIcon) {
      const { size, color, shape } = styles.minimapIcon;
      if (size !== null && size !== undefined) {
        lines.push(`  MinimapIcon ${size} ${color || "Orange"} ${shape || "Kite"}`);
      }
    }
    if (styles.playAlertSound) {
      const { id, volume } = styles.playAlertSound;
      lines.push(`  PlayAlertSound ${id} ${volume}`);
    }
    if (styles.customSound) {
      lines.push(`  CustomAlertSound "${styles.customSound}"`);
      if (styles.soundVolume) {
        lines.push(`  CustomAlertSoundOptional ${styles.soundVolume}`);
      }
    }

    lines.push("");
  });
}

/**
 * 기타 (주문 감정서 등) 규칙 생성
 */
function generateOthersRules(lines, othersSettings, lang = "ko") {
  if (othersSettings.enabled === false) {
    return;
  }

  othersSettings.rules.forEach((rule) => {
    if (!rule.enabled) {
      return;
    }

    // 제목 주석
    const title = lang === "ko" ? rule.nameKo || rule.name : rule.name;
    lines.push(`# ${title}`);

    // RID 주석
    lines.push(`# [RID: ${rule.id}]`);

    // Show/Hide
    lines.push(rule.type === "hide" ? "Hide" : "Show");

    // Class 조건
    if (rule.conditions?.class) {
      const classValue = rule.conditions.class.value;
      if (Array.isArray(classValue)) {
        const classes = classValue.map((c) => `"${c}"`).join(" ");
        lines.push(`  Class == ${classes}`);
      } else {
        lines.push(`  Class == "${classValue}"`);
      }
    }

    // BaseType 조건 (단수)
    if (rule.conditions?.baseType) {
      const baseTypeValue = rule.conditions.baseType.value;
      if (Array.isArray(baseTypeValue)) {
        const baseTypes = baseTypeValue.map((b) => `"${b}"`).join(" ");
        lines.push(`  BaseType == ${baseTypes}`);
      } else {
        lines.push(`  BaseType == "${baseTypeValue}"`);
      }
    }

    // BaseType 조건 (복수 - baseTypes 배열)
    if (rule.conditions?.baseTypes && Array.isArray(rule.conditions.baseTypes)) {
      const baseTypes = rule.conditions.baseTypes.map((b) => `"${b}"`).join(" ");
      lines.push(`  BaseType == ${baseTypes}`);
    }

    // AreaLevel 조건
    if (rule.conditions?.areaLevel) {
      const { operator, value } = rule.conditions.areaLevel;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }

    // Rarity 조건
    if (rule.conditions?.rarity) {
      const { operator, value } = rule.conditions.rarity;
      lines.push(`  Rarity ${operator || "=="} ${value}`);
    }

    // Corrupted 조건
    if (rule.conditions?.corrupted !== undefined) {
      const corruptedValue = rule.conditions.corrupted.value;
      lines.push(`  Corrupted ${corruptedValue ? "True" : "False"}`);
    }

    // BaseTypes 배열 조건 (찬스 아이템 등)
    if (rule.conditions?.baseTypes && Array.isArray(rule.conditions.baseTypes) && rule.conditions.baseTypes.length > 0) {
      // 한글 아이템 이름을 영어로 변환하는 매핑
      const koToEnMapping = {
        "무궁한 주얼": "Timeless Jewel",
        "은 호신부": "Silver Charm",
        "무거운 허리띠": "Heavy Belt",
        "가죽 허리띠": "Leather Belt",
        "천 허리띠": "Cloth Belt",
        "황금 주얼": "Gold Jewel",
        "영롱한 주얼": "Prismatic Jewel",
        "심연 주얼": "Abyss Jewel",
        "군단 주얼": "Legion Jewel",
        "금 호신부": "Gold Charm",
        "상아 호신부": "Ivory Charm",
        "뼈 호신부": "Bone Charm"
      };
      
      // 한글 이름을 영어로 변환 (매핑에 없으면 원래 이름 사용)
      const englishBaseTypes = rule.conditions.baseTypes.map(item => 
        koToEnMapping[item] || item
      );
      
      const baseTypesStr = englishBaseTypes.map((b) => `"${b}"`).join(" ");
      lines.push(`  BaseType == ${baseTypesStr}`);
    }

    // 스타일 적용
    if (rule.type === "show" && rule.styles) {
      const styles = rule.styles;

      if (styles.fontSize) {
        lines.push(`  SetFontSize ${styles.fontSize}`);
      }

      if (styles.textColor) {
        const { r, g, b, a } = styles.textColor;
        lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.borderColor) {
        const { r, g, b, a } = styles.borderColor;
        lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.backgroundColor) {
        const { r, g, b, a } = styles.backgroundColor;
        lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
      }

      if (styles.playEffect) {
        lines.push(`  PlayEffect ${styles.playEffect}`);
      }

      if (styles.minimapIcon) {
        const { size, color, shape } = styles.minimapIcon;
        if (size !== null || color !== null || shape !== null) {
          lines.push(`  MinimapIcon ${size || 0} ${color || "White"} ${shape || "Circle"}`);
        }
      }

      if (styles.customSound) {
        lines.push(`  CustomAlertSound "${styles.customSound}" 300`);
      }
    }

    lines.push("");
  });
}

