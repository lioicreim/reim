/**
 * 필터 코드 생성기
 * 프리셋 설정과 티어 리스트 데이터를 기반으로 .filter 파일 형식의 코드를 생성합니다.
 */

import bases from "@/data/bases.json";
import classes from "@/data/classes.json";
import currencyTiers from "@/data/currency-tiers.json";
import filterRules from "@/data/filter-rules.json";
import presets from "@/data/presets.json";

/**
 * 필터 코드 생성
 * @param {Object} options - 필터 생성 옵션
 * @param {string} options.presetId - 프리셋 ID
 * @param {boolean} options.isPS5 - PS5 모드 여부
 * @param {Object} options.excludedOptions - 제외 옵션
 * @param {Object} options.customGearTiers - 커스텀 장비 티어 (로컬스토리지에서)
 * @param {Object} options.customCurrencyTiers - 커스텀 화폐 티어 (로컬스토리지에서)
 * @param {string} options.selectedLeague - 선택된 리그 (기본값, early, normal, late, ssf)
 * @returns {string} 생성된 필터 코드
 */
export function generateFilterCode(options) {
  const {
    presetId = "starter",
    isPS5 = false,
    excludedOptions = {},
    customGearTiers = {},
    customCurrencyTiers = {},
    selectedLeague = "default",
  } = options;

  const preset = presets.presets.find((p) => p.id === presetId);
  if (!preset) {
    throw new Error(`Preset not found: ${presetId}`);
  }

  const lines = [];

  // 필터 헤더
  lines.push("# Filter generated by GAMEBOX");
  lines.push(`# Preset: ${preset.nameKo || preset.name}`);
  lines.push(`# Generated: ${new Date().toISOString()}`);
  lines.push("");

  // 리그 키 결정 (기본값은 normal 사용)
  const leagueKey = selectedLeague === "default" ? "normal" : selectedLeague;

  // 베이스 아이템 규칙 생성
  generateGearRules(lines, preset, customGearTiers, excludedOptions, isPS5);

  // 미감정 아이템 규칙 생성
  if (preset.rules.showUnidentified) {
    generateUnidentifiedRules(lines, preset, customGearTiers, isPS5);
  }

  // 화폐 규칙 생성
  generateCurrencyRules(lines, preset, customCurrencyTiers, leagueKey, isPS5);

  // 골드 규칙 생성 (빠른 설정에서)
  if (options.quickFilterSettings?.gold) {
    generateGoldRules(lines, options.quickFilterSettings.gold);
  }

  // 찬스 아이템 규칙 생성
  generateChanceRules(
    lines,
    preset,
    options.quickFilterSettings?.chance,
    isPS5
  );

  // 레벨링 직업 선택 규칙 생성
  if (options.quickFilterSettings?.levelingClassSelection) {
    generateLevelingClassSelectionRules(
      lines,
      options.quickFilterSettings.levelingClassSelection
    );
  }

  // 기타 규칙들 (유니크, 징조 등은 나중에 추가)
  // generateOtherRules(lines, preset, isPS5);

  return lines.join("\n");
}

/**
 * 장비 규칙 생성
 */
function generateGearRules(
  lines,
  preset,
  customGearTiers,
  excludedOptions,
  isPS5
) {
  const gearTiers = preset.rules.gearTiers || [];
  const minIlvl = preset.itemLevel.min;
  const useBaseMinIlvl = preset.itemLevel.useBaseMinIlvl;

  // 티어별로 그룹화
  const itemsByTier = {};
  gearTiers.forEach((tier) => {
    itemsByTier[tier] = [];
  });

  // 베이스 아이템을 티어별로 분류
  Object.keys(bases).forEach((itemName) => {
    const item = bases[itemName];
    let finalTier = item.tier || 4;

    // 커스텀 티어 확인
    if (customGearTiers[itemName]) {
      const customTier = customGearTiers[itemName];
      // S->1, A->2, B->3, C->4, D->5, E->6 변환
      const tierMap = { S: 1, A: 2, B: 3, C: 4, D: 5, E: 6 };
      finalTier = tierMap[customTier] || finalTier;
    }

    // 프리셋에서 지정한 티어에 포함되는지 확인
    if (gearTiers.includes(finalTier)) {
      if (!itemsByTier[finalTier]) {
        itemsByTier[finalTier] = [];
      }
      itemsByTier[finalTier].push({ name: itemName, ...item });
    }
  });

  // 티어별로 규칙 생성
  gearTiers.forEach((tier) => {
    const items = itemsByTier[tier] || [];
    if (items.length === 0) return;

    // 클래스별로 그룹화
    const itemsByClass = {};
    items.forEach((item) => {
      if (!itemsByClass[item.class]) {
        itemsByClass[item.class] = [];
      }
      itemsByClass[item.class].push(item);
    });

    // 클래스별로 규칙 생성
    Object.keys(itemsByClass).forEach((className) => {
      const classItems = itemsByClass[className];
      const baseTypes = classItems.map((item) => item.name);
      const capIlvl = classes[className]?.capIlvl;
      const classMinIlvl = classes[className]?.minIlvl;
      const presetId = preset.id;

      // T15+6모드의 경우 최소 레벨과 최대 레벨 두 규칙을 모두 생성
      if (
        tier === 1 &&
        presetId === "verystrict" &&
        capIlvl &&
        classMinIlvl !== null &&
        classMinIlvl !== undefined
      ) {
        // 최소 레벨 규칙 생성
        generateTier1Rule(
          lines,
          tier,
          className,
          baseTypes,
          classMinIlvl,
          capIlvl,
          preset,
          classItems,
          minIlvl,
          useBaseMinIlvl,
          isPS5,
          "min"
        );
        // 최대 레벨 규칙 생성
        generateTier1Rule(
          lines,
          tier,
          className,
          baseTypes,
          classMinIlvl,
          capIlvl,
          preset,
          classItems,
          minIlvl,
          useBaseMinIlvl,
          isPS5,
          "max"
        );
      } else {
        // 일반 규칙 생성
        generateTier1Rule(
          lines,
          tier,
          className,
          baseTypes,
          classMinIlvl,
          capIlvl,
          preset,
          classItems,
          minIlvl,
          useBaseMinIlvl,
          isPS5,
          null
        );
      }
    });
  });
}

/**
 * 1티어 규칙 생성 헬퍼 함수
 */
function generateTier1Rule(
  lines,
  tier,
  className,
  baseTypes,
  classMinIlvl,
  capIlvl,
  preset,
  classItems,
  minIlvl,
  useBaseMinIlvl,
  isPS5,
  levelType
) {
  // SECTION 주석
  lines.push(`# [SECTION: gear_bases]`);

  // RID 주석 (간단한 형식)
  const levelSuffix = levelType ? `_${levelType}` : "";
  lines.push(
    `# [RID: gear_bases_t${tier}_${className.toLowerCase()}${levelSuffix}]`
  );
  lines.push("Show");

  // ItemLevel 조건
  // 1티어의 경우 프리셋에 따라 최소/최대 레벨 조건이 다름
  if (tier === 1) {
    const presetId = preset.id;

    if (presetId === "starter" || presetId === "strict") {
      // 리그 스타터, T1-T14: 최소 레벨부터 최대 레벨까지 표시
      if (classMinIlvl !== null && classMinIlvl !== undefined) {
        lines.push(`  ItemLevel >= ${classMinIlvl}`);
      } else {
        lines.push(`  ItemLevel >= ${minIlvl}`);
      }
      // 최대 레벨 제한은 없음 (최소 레벨 이상이면 모두 표시)
    } else if (presetId === "verystrict") {
      // T15+6모드: 최소 레벨 또는 최대 레벨
      if (levelType === "min") {
        // 최소 레벨 규칙
        if (classMinIlvl !== null && classMinIlvl !== undefined) {
          lines.push(`  ItemLevel >= ${classMinIlvl}`);
        } else {
          lines.push(`  ItemLevel >= ${minIlvl}`);
        }
      } else if (levelType === "max") {
        // 최대 레벨 규칙
        if (capIlvl) {
          lines.push(`  ItemLevel >= ${capIlvl}`);
        }
      }
    } else if (presetId === "uber" || presetId === "vaal") {
      // Uber, Vaal: 최대 레벨만 표시
      if (capIlvl) {
        lines.push(`  ItemLevel >= ${capIlvl}`);
      } else if (classMinIlvl !== null && classMinIlvl !== undefined) {
        lines.push(`  ItemLevel >= ${classMinIlvl}`);
      } else {
        lines.push(`  ItemLevel >= ${minIlvl}`);
      }
    } else {
      // 기본값: 최대 레벨 사용
      if (capIlvl) {
        lines.push(`  ItemLevel >= ${capIlvl}`);
      } else if (classMinIlvl !== null && classMinIlvl !== undefined) {
        lines.push(`  ItemLevel >= ${classMinIlvl}`);
      } else {
        lines.push(`  ItemLevel >= ${minIlvl}`);
      }
    }
  } else {
    // 클래스별 최소 레벨 우선 사용
    if (classMinIlvl !== null && classMinIlvl !== undefined) {
      // 클래스에 최소 레벨이 있으면 사용
      lines.push(`  ItemLevel >= ${classMinIlvl}`);
    } else if (useBaseMinIlvl) {
      // 베이스별 최소 레벨 사용
      // 각 아이템마다 개별 규칙을 만들거나, 최소값을 사용
      const minBaseIlvl = Math.min(
        ...classItems.map((item) => {
          // bases.json에서 minIlvl이 있는지 확인
          return item.minIlvl || minIlvl;
        })
      );
      lines.push(`  ItemLevel >= ${minBaseIlvl}`);
    } else {
      // 프리셋의 전역 최소 레벨 사용
      lines.push(`  ItemLevel >= ${minIlvl}`);
    }
  }

  // Class 조건
  lines.push(`  Class == "${className}"`);

  // BaseType 조건
  if (baseTypes.length > 0) {
    const baseTypeLine = baseTypes.map((name) => `"${name}"`).join(" ");
    lines.push(`  BaseType == ${baseTypeLine}`);
  }

  // Rarity 조건
  if (tier === 3 && preset.rules.gearTier3Rarity) {
    lines.push(`  Rarity == ${preset.rules.gearTier3Rarity}`);
  } else if (!preset.rules.showNormalItems && !preset.rules.showMagicItems) {
    lines.push(`  Rarity == Rare`);
  }

  // TODO: 특출 아이템 처리
  // 특출: 1소켓이 2소켓으로, 2소켓이 3소켓으로 드롭되는 아이템
  // 특출 아이템 리스트를 받으면 여기에 조건 추가 예정
  // 예: Sockets >= 2 (1소켓 아이템이 2소켓 이상으로 드롭된 경우)

  // 스타일 적용
  const tierColors = getTierColors(tier);
  lines.push(`  SetFontSize ${tierColors.fontSize}`);
  lines.push(`  SetTextColor ${tierColors.textColor}`);
  lines.push(`  SetBorderColor ${tierColors.borderColor}`);
  lines.push(`  SetBackgroundColor ${tierColors.backgroundColor}`);

  // PlayEffect
  if (tierColors.playEffect) {
    lines.push(`  PlayEffect ${tierColors.playEffect}`);
  }

  // 사운드 (PS5 모드면 인게임 사운드로 변환, 아니면 커스텀 사운드)
  // 기획 문서에 따른 1:1 매핑: T1 -> PlayAlertSound 1 300, T2 -> PlayAlertSound 2 300, T3는 PS5에서 사운드 없음
  // 자동생성시에는 T1, T2도 기본값으로 사운드를 넣지 않음 (사용자가 사운드 관리 페이지에서 설정)
  // PS5 모드일 때만 사운드 추가
  if (isPS5) {
    const ps5SoundMap = { 1: 1, 2: 2, 3: null, 4: null };
    const ps5Sound = ps5SoundMap[tier];
    if (ps5Sound !== null) {
      lines.push(`  PlayAlertSound ${ps5Sound} 300`);
    }
    // T3, T4는 PS5에서 사운드 없음 (기획 문서 참조)
  }
  // PC 모드에서는 자동생성시 사운드를 넣지 않음 (사운드 관리 페이지에서 설정)

  lines.push("");
}

/**
 * 미감정 아이템 규칙 생성 (빛기둥)
 */
function generateUnidentifiedRules(lines, preset, customGearTiers, isPS5) {
  const unidentifiedTiers = preset.rules.unidentifiedTiers || [];
  if (unidentifiedTiers.length === 0) return;

  const gearTiers = preset.rules.gearTiers || [];

  // 미감정 아이템은 1티어만 적용 (스크린샷 기준)
  if (!gearTiers.includes(1)) return;

  // 5등급: Red 빛기둥
  if (unidentifiedTiers.includes(5)) {
    generateUnidentifiedTierRule(
      lines,
      5,
      "Red",
      gearTiers,
      customGearTiers,
      isPS5
    );
  }

  // 4등급: Yellow 빛기둥
  if (unidentifiedTiers.includes(4)) {
    generateUnidentifiedTierRule(
      lines,
      4,
      "Yellow",
      gearTiers,
      customGearTiers,
      isPS5
    );
  }

  // 3등급 이하는 unidentifiedTiers에 포함되지 않으면 숨김 (별도 처리 불필요)
}

/**
 * 미감정 등급별 규칙 생성
 */
function generateUnidentifiedTierRule(
  lines,
  grade,
  effectColor,
  gearTiers,
  customGearTiers,
  isPS5
) {
  // 1티어 아이템만 처리
  if (!gearTiers.includes(1)) return;

  // 1티어 아이템들을 클래스별로 그룹화
  const itemsByClass = {};

  Object.keys(bases).forEach((itemName) => {
    const item = bases[itemName];
    let finalTier = item.tier || 4;

    // 커스텀 티어 확인
    if (customGearTiers[itemName]) {
      const customTier = customGearTiers[itemName];
      const tierMap = { S: 1, A: 2, B: 3, C: 4, D: 5, E: 6 };
      finalTier = tierMap[customTier] || finalTier;
    }

    // 1티어만 처리
    if (finalTier === 1) {
      const className = item.class;
      if (!itemsByClass[className]) {
        itemsByClass[className] = [];
      }
      itemsByClass[className].push({ name: itemName, ...item });
    }
  });

  // 클래스별로 규칙 생성
  Object.keys(itemsByClass).forEach((className) => {
    const classItems = itemsByClass[className];
    const baseTypes = classItems.map((item) => item.name);
    const capIlvl = classes[className]?.capIlvl;

    // SECTION 주석
    lines.push(`# [SECTION: unidentified_items]`);

    // RID 주석
    lines.push(
      `# [RID: unidentified_grade${grade}_t1_${className.toLowerCase()}]`
    );
    lines.push("Show");

    // 미감정 등급 조건
    lines.push(`  UnidentifiedItemTier == ${grade}`);

    // 1티어는 최대 레벨(capIlvl) 이상만 표시
    if (capIlvl) {
      lines.push(`  ItemLevel >= ${capIlvl}`);
    }

    // Class 조건
    lines.push(`  Class == "${className}"`);

    // BaseType 조건
    if (baseTypes.length > 0) {
      const baseTypeLine = baseTypes.map((name) => `"${name}"`).join(" ");
      lines.push(`  BaseType == ${baseTypeLine}`);
    }

    // 빛기둥 효과 (PlayEffect)
    lines.push(`  PlayEffect ${effectColor}`);

    // 스타일은 기본값 사용 (또는 프리셋별로 다를 수 있음)
    // 여기서는 빛기둥만 강조하므로 기본 스타일 사용
    lines.push(`  SetFontSize 45`);
    lines.push(`  SetTextColor 255 255 255 255`);
    lines.push(`  SetBorderColor 255 255 255 255`);
    lines.push(`  SetBackgroundColor 0 0 0 255`);

    // TODO: 특출 아이템 처리
    // 특출: 1소켓이 2소켓으로, 2소켓이 3소켓으로 드롭되는 아이템
    // 특출 아이템 리스트를 받으면 여기에 조건 추가 예정
    // 예: Sockets >= 2 (1소켓 아이템이 2소켓 이상으로 드롭된 경우)

    lines.push("");
  });
}

/**
 * 화폐 규칙 생성
 */
function generateCurrencyRules(
  lines,
  preset,
  customCurrencyTiers,
  leagueKey,
  isPS5
) {
  const currencyTierList = preset.rules.currencyTiers || [];
  const tierMapping = { S: "S", A: "A", B: "B", C: "C", D: "D", E: "E" };

  // 리그별 화폐 데이터 가져오기
  const leagueCurrencyData =
    currencyTiers[leagueKey] || currencyTiers.normal || {};

  currencyTierList.forEach((tier) => {
    const tierKey = tierMapping[tier] || tier;
    const currencyItems = leagueCurrencyData[tierKey] || [];

    if (currencyItems.length === 0) return;

    // 커스텀 티어 적용
    const finalItems = currencyItems.filter((itemName) => {
      const customTier = customCurrencyTiers[itemName]?.[leagueKey];
      if (customTier) {
        return customTier === tier;
      }
      return true; // 커스텀 티어가 없으면 기본 티어 사용
    });

    if (finalItems.length === 0) return;

    // SECTION 주석
    lines.push(`# [SECTION: currency]`);

    // RID 주석
    lines.push(`# [RID: currency_${tierKey.toLowerCase()}]`);
    lines.push("Show");

    // Class 조건 (화폐는 일반적으로 "Stackable Currency" 또는 특정 클래스)
    lines.push(`  Class == "Stackable Currency"`);

    // BaseType 조건
    const baseTypeLine = finalItems.map((name) => `"${name}"`).join(" ");
    lines.push(`  BaseType == ${baseTypeLine}`);

    // 스타일 적용
    const tierColors = getCurrencyTierColors(tierKey);
    lines.push(`  SetFontSize ${tierColors.fontSize}`);
    lines.push(`  SetTextColor ${tierColors.textColor}`);
    lines.push(`  SetBorderColor ${tierColors.borderColor}`);
    lines.push(`  SetBackgroundColor ${tierColors.backgroundColor}`);

    // PlayEffect
    if (tierColors.playEffect) {
      lines.push(`  PlayEffect ${tierColors.playEffect}`);
    }

    // MinimapIcon
    if (tierColors.minimapIcon) {
      lines.push(`  MinimapIcon ${tierColors.minimapIcon}`);
    }

    // 사운드 (PS5 모드면 인게임 사운드로 변환, 아니면 커스텀 사운드)
    if (isPS5) {
      // PS5 사운드 매핑: S -> PlayAlertSound 5 300, A -> PlayAlertSound 1 300, B -> PlayAlertSound 2 300, C -> PlayAlertSound 2 300
      const ps5SoundMap = { S: 5, A: 1, B: 2, C: 2, D: null, E: null };
      const ps5Sound = ps5SoundMap[tierKey];
      if (ps5Sound !== null) {
        lines.push(`  PlayAlertSound ${ps5Sound} 300`);
      }
    } else if (tierColors.customSound) {
      lines.push(`  CustomAlertSound "${tierColors.customSound}" 300`);
    }

    lines.push("");
  });
}

/**
 * 장비 티어별 색상 및 스타일
 */
function getTierColors(tier) {
  const tierStyles = {
    1: {
      fontSize: 45,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "255 255 255 255",
      playEffect: "Red",
      customSound: "custom_sound/1_gear_t1.mp3",
    },
    2: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "204 90 138 255",
      playEffect: "Orange",
      customSound: "custom_sound/2_gear_t2.mp3",
    },
    3: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "205 82 80 255",
      playEffect: "Yellow",
      customSound: "custom_sound/3_gear_t3.mp3",
    },
    4: {
      fontSize: 42,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "255 165 0 255",
      playEffect: null,
      customSound: "custom_sound/4_gear_t4.mp3",
    },
  };

  return tierStyles[tier] || tierStyles[4];
}

/**
 * 화폐 티어별 색상 및 스타일
 */
function getCurrencyTierColors(tier) {
  const tierStyles = {
    S: {
      fontSize: 45,
      textColor: "255 0 0 255",
      borderColor: "255 0 0 255",
      backgroundColor: "255 255 255 255",
      playEffect: "Red",
      minimapIcon: "0 Red Star",
      customSound: "custom_sound/1_currency_s.mp3",
    },
    A: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "240 35 120 255",
      playEffect: "Orange",
      minimapIcon: "0 Orange Circle",
      customSound: "custom_sound/2_currency_a.mp3",
    },
    B: {
      fontSize: 45,
      textColor: "255 255 255 255",
      borderColor: "255 255 255 255",
      backgroundColor: "240 90 35 255",
      playEffect: "Yellow",
      minimapIcon: "1 Yellow Circle",
      customSound: "custom_sound/3_currency_b.mp3",
    },
    C: {
      fontSize: 42,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "249 150 25 255",
      playEffect: null,
      minimapIcon: "1 Yellow Circle",
      customSound: "custom_sound/4_currency_c.mp3",
    },
    D: {
      fontSize: 42,
      textColor: "0 0 0 255",
      borderColor: "0 0 0 255",
      backgroundColor: "210 178 135 255",
      playEffect: null,
      minimapIcon: null,
      customSound: null,
    },
    E: {
      fontSize: 38,
      textColor: "220 175 132 255",
      borderColor: "0 0 0 255",
      backgroundColor: "0 0 0 255",
      playEffect: null,
      minimapIcon: null,
      customSound: null,
    },
  };

  return tierStyles[tier] || tierStyles.D;
}

/**
 * 골드 규칙 생성
 */
function generateGoldRules(lines, goldSettings) {
  // 골드가 비활성화되어 있으면 모든 규칙을 Hide로 생성
  // enabled가 undefined일 경우 기본값 true로 처리
  const shouldHideAll = goldSettings.enabled === false;

  goldSettings.rules.forEach((rule) => {
    // 골드가 비활성화되어 있거나 개별 규칙이 비활성화되어 있으면 Hide로 변경
    const shouldHide = shouldHideAll || !rule.enabled;

    if (shouldHide) {
      // Hide 규칙 생성
      if (rule.nameKo || rule.name) {
        lines.push(`# ${rule.nameKo || rule.name} (비활성화됨)`);
      }
      lines.push(`# [RID: ${rule.id}]`);
      lines.push("Hide");

      // Class 조건
      if (rule.id === "gold_default") {
        lines.push(`  Class == "Currency"`);
      } else {
        lines.push(`  Class == "Stackable Currency"`);
      }

      // BaseType 조건
      lines.push(`  BaseType == "골드"`);

      // AreaLevel 조건
      if (rule.conditions?.areaLevel) {
        const { operator, value } = rule.conditions.areaLevel;
        lines.push(`  AreaLevel ${operator} ${value}`);
      }

      // StackSize 조건
      if (rule.conditions?.stackSize) {
        const { operator, value } = rule.conditions.stackSize;
        lines.push(`  StackSize ${operator} ${value}`);
      }

      lines.push("");
      return;
    }

    // 제목을 주석으로 추가
    if (rule.nameKo || rule.name) {
      lines.push(`# ${rule.nameKo || rule.name}`);
    }

    // RID 주석
    lines.push(`# [RID: ${rule.id}]`);

    // Show/Hide
    lines.push(rule.type === "hide" ? "Hide" : "Show");

    // Class 조건 (골드는 일반적으로 "Stackable Currency" 또는 "Currency")
    // 기본값 규칙은 "Currency", 나머지는 "Stackable Currency"
    if (rule.id === "gold_default") {
      lines.push(`  Class == "Currency"`);
    } else {
      lines.push(`  Class == "Stackable Currency"`);
    }

    // BaseType 조건
    lines.push(`  BaseType == "골드"`);

    // AreaLevel 조건
    if (rule.conditions?.areaLevel) {
      const { operator, value } = rule.conditions.areaLevel;
      lines.push(`  AreaLevel ${operator} ${value}`);
    }

    // StackSize 조건
    if (rule.conditions?.stackSize) {
      const { operator, value } = rule.conditions.stackSize;
      lines.push(`  StackSize ${operator} ${value}`);
    }

    // 스타일 적용 (Show 타입만, Hide로 변경된 경우 스타일 적용 안함)
    if (!shouldHide && rule.type === "show" && rule.styles) {
      if (rule.styles.fontSize) {
        lines.push(`  SetFontSize ${rule.styles.fontSize}`);
      }

      if (rule.styles.textColor) {
        const { r, g, b, a } = rule.styles.textColor;
        lines.push(`  SetTextColor ${r} ${g} ${b} ${a}`);
      }

      if (rule.styles.borderColor) {
        const { r, g, b, a } = rule.styles.borderColor;
        lines.push(`  SetBorderColor ${r} ${g} ${b} ${a}`);
      }

      if (rule.styles.backgroundColor) {
        const { r, g, b, a } = rule.styles.backgroundColor;
        lines.push(`  SetBackgroundColor ${r} ${g} ${b} ${a}`);
      }

      if (rule.styles.playEffect) {
        lines.push(`  PlayEffect ${rule.styles.playEffect}`);
      }
    }

    lines.push("");
  });
}

/**
 * 찬스 아이템 규칙 생성
 */
function generateChanceRules(lines, preset, chanceSettings, isPS5) {
  // 빠른 설정에서 체크해제했으면 Hide, 기본값은 Show
  const isEnabled = chanceSettings?.enabled !== false; // 기본값 true
  const showHide = isEnabled ? "Show" : "Hide";

  // SECTION 주석
  lines.push("#==================================================");
  lines.push("# [SECTION: chance]");
  lines.push("# 찬스 아이템 | Chance Base");
  lines.push("#==================================================");
  lines.push("");

  // RID 주석
  lines.push("# 찬스 아이템");
  lines.push("# [RID: chance_base]");
  lines.push(showHide);

  // 조건
  lines.push(`  BaseType == "Timeless Jewel" "Silver Charm" "Heavy Belt"`);
  lines.push(`  Rarity == Normal`);
  lines.push(`  Corrupted False`);

  // 스타일
  lines.push(`  SetFontSize 45`);
  lines.push(`  SetTextColor 255 0 0 255 #빨강`);
  lines.push(`  SetBorderColor 255 0 0 255 #빨강`);
  lines.push(`  SetBackgroundColor 31 12 8 255 #붉은색계열 블랙`);
  lines.push(`  MinimapIcon 2 Brown Kite`);

  // 사운드 처리
  const presetId = preset.id;
  // Vaal 프리셋에서는 A티어 이하 사운드 제거이므로 사운드 코드 제거
  if (presetId !== "vaal") {
    if (isPS5) {
      // PS5 모드: CustomAlertSound → PlayAlertSound 1 300
      lines.push(`  PlayAlertSound 1 300`);
    } else {
      // PC 모드: CustomAlertSound 사용
      lines.push(`  CustomAlertSound "custom_sound/2_currency_a.mp3" 300`);
    }
  }
  // Vaal 프리셋에서는 사운드 코드를 추가하지 않음

  lines.push("");
}

/**
 * 레벨링 직업 선택 규칙 생성
 */
function generateLevelingClassSelectionRules(lines, levelingClassSelection) {
  // 활성화되지 않았으면 규칙 생성 안함
  if (!levelingClassSelection.enabled) {
    return;
  }

  // SECTION 주석
  lines.push("#==================================================");
  lines.push("# [SECTION: leveling_class_selection]");
  lines.push("# 레벨링 직업 선택 | Leveling Class Selection");
  lines.push("#==================================================");
  lines.push("");

  // 무기 규칙 생성
  if (levelingClassSelection.weaponTypes.length > 0) {
    generateLevelingWeaponRule(
      lines,
      levelingClassSelection,
      "gear-leveling-weapons"
    );
  }

  // 방어구 규칙 생성
  if (levelingClassSelection.armourTypes.length > 0) {
    generateLevelingArmourRule(
      lines,
      levelingClassSelection,
      "gear-leveling-armour"
    );
  }
}

/**
 * 레벨링 무기 규칙 생성
 */
function generateLevelingWeaponRule(
  lines,
  levelingClassSelection,
  ruleIdPrefix
) {
  const weaponTypeMap = {
    spears: "Spears",
    talismans: "Talismans",
    quarterstaves: "Quarterstaves",
    sceptres: "Sceptres",
    wands: "Wands",
    staves: "Staves",
    bows: "Bows",
    quivers: "Quivers",
    crossbows: "Crossbows",
    one_hand_maces: "One Hand Maces",
    two_hand_maces: "Two Hand Maces",
    foci: "Foci",
  };

  const classNames = levelingClassSelection.weaponTypes
    .map((type) => weaponTypeMap[type])
    .filter(Boolean)
    .map((name) => `"${name}"`)
    .join(" ");

  if (!classNames) return;

  // Rarity별로 규칙 생성
  const rarityTypes = [];
  if (levelingClassSelection.rarity.rare) {
    rarityTypes.push({ type: "Rare", id: "rare" });
  }
  if (levelingClassSelection.rarity.magic) {
    rarityTypes.push({ type: "Magic", id: "magic" });
  }
  if (levelingClassSelection.rarity.normal) {
    rarityTypes.push({ type: "Normal", id: "normal" });
  }

  if (rarityTypes.length === 0) return;

  rarityTypes.forEach((rarity) => {
    // 제목 주석
    lines.push(
      `# ${rarity.type} Leveling Weapons (${ruleIdPrefix}-${rarity.id})`
    );

    // RID 주석
    lines.push(`# [RID: ${ruleIdPrefix}-${rarity.id}]`);

    // Show
    lines.push("Show");

    // AreaLevel 조건
    lines.push("  AreaLevel <= 65");

    // Class 조건 (무기 클래스들)
    lines.push(`  Class == ${classNames}`);

    // Rarity 조건
    lines.push(`  Rarity == ${rarity.type}`);

    // 스타일 (예시: White 효과)
    lines.push("  PlayEffect White");
    lines.push("  MinimapIcon 2 White Kite");

    lines.push("");
  });
}

/**
 * 레벨링 방어구 규칙 생성
 */
function generateLevelingArmourRule(
  lines,
  levelingClassSelection,
  ruleIdPrefix
) {
  // 방어구 타입별 BaseArmour, BaseEvasion, BaseEnergyShield 조건
  const armourTypeConditions = {
    AR: {
      baseArmour: ">= 1",
      baseEvasion: "== 0",
      baseEnergyShield: "== 0",
    },
    ES: {
      baseArmour: "== 0",
      baseEvasion: "== 0",
      baseEnergyShield: ">= 1",
    },
    EV: {
      baseArmour: "== 0",
      baseEvasion: ">= 1",
      baseEnergyShield: "== 0",
    },
    "AR/ES": {
      baseArmour: ">= 1",
      baseEvasion: "== 0",
      baseEnergyShield: ">= 1",
    },
    "AR/EV": {
      baseArmour: ">= 1",
      baseEvasion: ">= 1",
      baseEnergyShield: "== 0",
    },
    "EV/ES": {
      baseArmour: "== 0",
      baseEvasion: ">= 1",
      baseEnergyShield: ">= 1",
    },
    "AR/EV/ES": {
      baseArmour: ">= 1",
      baseEvasion: ">= 1",
      baseEnergyShield: ">= 1",
    },
  };

  // 방어구 Class 목록
  const armourClasses = [
    "Body Armours",
    "Boots",
    "Gloves",
    "Helmets",
    "Shields",
  ]
    .map((name) => `"${name}"`)
    .join(" ");

  // Rarity별로 규칙 생성
  const rarityTypes = [];
  if (levelingClassSelection.rarity.rare) {
    rarityTypes.push({ type: "Rare", id: "rare" });
  }
  if (levelingClassSelection.rarity.magic) {
    rarityTypes.push({ type: "Magic", id: "magic" });
  }
  if (levelingClassSelection.rarity.normal) {
    rarityTypes.push({ type: "Normal", id: "normal" });
  }

  if (rarityTypes.length === 0) return;

  // 방어구 타입별로 규칙 생성
  levelingClassSelection.armourTypes.forEach((armourType) => {
    const conditions = armourTypeConditions[armourType];
    if (!conditions) return;

    rarityTypes.forEach((rarity) => {
      // 제목 주석
      lines.push(
        `# ${rarity.type} Leveling Armour (${ruleIdPrefix}-${rarity.id})`
      );

      // RID 주석
      lines.push(
        `# [RID: ${ruleIdPrefix}-${armourType.toLowerCase()}-${rarity.id}]`
      );

      // Show
      lines.push("Show");

      // BaseArmour 조건
      lines.push(`  BaseArmour ${conditions.baseArmour}`);

      // BaseEvasion 조건
      lines.push(`  BaseEvasion ${conditions.baseEvasion}`);

      // BaseEnergyShield 조건
      lines.push(`  BaseEnergyShield ${conditions.baseEnergyShield}`);

      // AreaLevel 조건
      lines.push("  AreaLevel <= 65");

      // Class 조건 (방어구 클래스들)
      lines.push(`  Class == ${armourClasses}`);

      // Rarity 조건
      lines.push(`  Rarity == ${rarity.type}`);

      // 스타일 (예시: White 효과)
      lines.push("  PlayEffect White");
      lines.push("  MinimapIcon 2 White Kite");

      lines.push("");
    });
  });
}
